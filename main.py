import pandas as pd
import geopandas as gpd
import matplotlib.pyplot as plt
import seaborn as sns
import platform

# --- í•œê¸€ í°íŠ¸ ì„¤ì • (Mac/Windows í˜¸í™˜)
if platform.system() == 'Darwin':
    plt.rc('font', family='AppleGothic')  # Mac
elif platform.system() == 'Windows':
    plt.rc('font', family='Malgun Gothic')  # Windows
plt.rcParams['axes.unicode_minus'] = False

# --- CSV ë¶ˆëŸ¬ì˜¤ê¸°
df_cctv = pd.read_csv("cctv.csv")
df_crime = pd.read_csv("crime.csv")
df_population = pd.read_csv("population.csv")

# --- SHP íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
gdf_streetlamp = gpd.read_file("FSN_30_20221130_G_001.shp")
gdf_streetlamp["ìœ„ë„"] = gdf_streetlamp.geometry.y
gdf_streetlamp["ê²½ë„"] = gdf_streetlamp.geometry.x

# --- ì„œìš¸ì‹œ ë²”ìœ„ë¡œ í•„í„°ë§
gdf_seoul = gdf_streetlamp[
    (gdf_streetlamp["ìœ„ë„"] >= 37.4) & (gdf_streetlamp["ìœ„ë„"] <= 37.7) &
    (gdf_streetlamp["ê²½ë„"] >= 126.7) & (gdf_streetlamp["ê²½ë„"] <= 127.2)
].copy()

# --- ë™ â†’ ìì¹˜êµ¬ ë§¤í•‘
dong_to_gu = {
    'ì••êµ¬ì •ë™': 'ê°•ë‚¨êµ¬', 'ì²­ë‹´ë™': 'ê°•ë‚¨êµ¬', 'ì‚¼ì„±ë™': 'ê°•ë‚¨êµ¬', 'ê°œí¬ë™': 'ê°•ë‚¨êµ¬', 'ì—­ì‚¼ë™': 'ê°•ë‚¨êµ¬', 'ì¼ì›ë™': 'ê°•ë‚¨êµ¬', 'ëŒ€ì¹˜ë™': 'ê°•ë‚¨êµ¬',
    'ì•”ì‚¬ë™': 'ê°•ë™êµ¬', 'ì„±ë‚´ë™': 'ê°•ë™êµ¬', 'ì²œí˜¸ë™': 'ê°•ë™êµ¬', 'ë‘”ì´Œë™': 'ê°•ë™êµ¬', 'ê°•ì¼ë™': 'ê°•ë™êµ¬',
    'ë¯¸ì•„ë™': 'ê°•ë¶êµ¬', 'ìˆ˜ìœ ë™': 'ê°•ë¶êµ¬', 'ë²ˆë™': 'ê°•ë¶êµ¬', 'ìš°ì´ë™': 'ê°•ë¶êµ¬',
    'ê°€ì–‘ë™': 'ê°•ì„œêµ¬', 'ì—¼ì°½ë™': 'ê°•ì„œêµ¬', 'ë“±ì´Œë™': 'ê°•ì„œêµ¬', 'í™”ê³¡ë™': 'ê°•ì„œêµ¬', 'ë‚´ë°œì‚°ë™': 'ê°•ì„œêµ¬', 'ì™¸ë°œì‚°ë™': 'ê°•ì„œêµ¬', 'ê³µí•­ë™': 'ê°•ì„œêµ¬',
    'ì‹ ë¦¼ë™': 'ê´€ì•…êµ¬', 'ë´‰ì²œë™': 'ê´€ì•…êµ¬',
    'ê´‘ì¥ë™': 'ê´‘ì§„êµ¬', 'êµ¬ì˜ë™': 'ê´‘ì§„êµ¬', 'ìì–‘ë™': 'ê´‘ì§„êµ¬', 'ì¤‘ê³¡ë™': 'ê´‘ì§„êµ¬', 'êµ°ìë™': 'ê´‘ì§„êµ¬', 'í™”ì–‘ë™': 'ê´‘ì§„êµ¬',
    'ê°œë´‰ë™': 'êµ¬ë¡œêµ¬', 'ê³ ì²™ë™': 'êµ¬ë¡œêµ¬', 'êµ¬ë¡œë™': 'êµ¬ë¡œêµ¬', 'ì‹ ë„ë¦¼ë™': 'êµ¬ë¡œêµ¬', 'ì˜¤ë¥˜ë™': 'êµ¬ë¡œêµ¬', 'ê°€ë¦¬ë´‰ë™': 'êµ¬ë¡œêµ¬',
    'ë‹¹ì‚°ë™': 'ì˜ë“±í¬êµ¬', 'ë¬¸ë˜ë™': 'ì˜ë“±í¬êµ¬', 'ì˜ë“±í¬ë™': 'ì˜ë“±í¬êµ¬', 'ì–‘í‰ë™': 'ì˜ë“±í¬êµ¬', 'ì‹ ê¸¸ë™': 'ì˜ë“±í¬êµ¬', 'ë„ë¦¼ë™': 'ì˜ë“±í¬êµ¬',
    'ë§ˆí¬ë™': 'ë§ˆí¬êµ¬', 'ë§ì›ë™': 'ë§ˆí¬êµ¬', 'ì„œêµë™': 'ë§ˆí¬êµ¬', 'ì„±ì‚°ë™': 'ë§ˆí¬êµ¬', 'ìƒì•”ë™': 'ë§ˆí¬êµ¬', 'ê³µë•ë™': 'ë§ˆí¬êµ¬',
    'ê°€ë½ë™': 'ì†¡íŒŒêµ¬', 'ë¬¸ì •ë™': 'ì†¡íŒŒêµ¬', 'ë°©ì´ë™': 'ì†¡íŒŒêµ¬', 'ì„ì´Œë™': 'ì†¡íŒŒêµ¬', 'ì†¡íŒŒë™': 'ì†¡íŒŒêµ¬', 'ì ì‹¤ë™': 'ì†¡íŒŒêµ¬',
    'ì‹ ì²œë™': 'ì†¡íŒŒêµ¬', 'í’ë‚©ë™': 'ì†¡íŒŒêµ¬', 'ê±°ì—¬ë™': 'ì†¡íŒŒêµ¬', 'ë§ˆì²œë™': 'ì†¡íŒŒêµ¬', 'ì˜¤ê¸ˆë™': 'ì†¡íŒŒêµ¬', 'ì¥ì§€ë™': 'ì†¡íŒŒêµ¬', 'ì‚¼ì „ë™': 'ì†¡íŒŒêµ¬',
    'ë…¸ëŸ‰ì§„ë™': 'ë™ì‘êµ¬', 'ìƒë„ë™': 'ë™ì‘êµ¬', 'ì‹ ëŒ€ë°©ë™': 'ë™ì‘êµ¬', 'í‘ì„ë™': 'ë™ì‘êµ¬',
    'ì´íƒœì›ë™': 'ìš©ì‚°êµ¬', 'í›„ì•”ë™': 'ìš©ì‚°êµ¬', 'ë™ìë™': 'ìš©ì‚°êµ¬', 'ì²­íŒŒë™': 'ìš©ì‚°êµ¬', 'ë³´ê´‘ë™': 'ìš©ì‚°êµ¬',
    'ì¢…ë¡œ1ê°€': 'ì¢…ë¡œêµ¬', 'ì¢…ë¡œ2ê°€': 'ì¢…ë¡œêµ¬', 'ì¢…ë¡œ3ê°€': 'ì¢…ë¡œêµ¬', 'ì¢…ë¡œ4ê°€': 'ì¢…ë¡œêµ¬', 'í˜œí™”ë™': 'ì¢…ë¡œêµ¬',
    'ëª…ë¥œ1ê°€': 'ì¢…ë¡œêµ¬', 'ëª…ë¥œ2ê°€': 'ì¢…ë¡œêµ¬', 'ì²­ìš´ë™': 'ì¢…ë¡œêµ¬', 'ì°½ì‹ ë™': 'ì¢…ë¡œêµ¬',
    'ì„ì§€ë¡œ1ê°€': 'ì¤‘êµ¬', 'ì„ì§€ë¡œ2ê°€': 'ì¤‘êµ¬', 'ì„ì§€ë¡œ3ê°€': 'ì¤‘êµ¬', 'ì„ì§€ë¡œ4ê°€': 'ì¤‘êµ¬', 'ì‹ ë‹¹ë™': 'ì¤‘êµ¬', 'í™©í•™ë™': 'ì¤‘êµ¬',
    'ì¥ì¶©ë™1ê°€': 'ì¤‘êµ¬', 'ì¥ì¶©ë™2ê°€': 'ì¤‘êµ¬', 'í•„ë™': 'ì¤‘êµ¬', 'ì¶©ë¬´ë¡œ1ê°€': 'ì¤‘êµ¬', 'ì¶©ë¬´ë¡œ2ê°€': 'ì¤‘êµ¬',
    'ê´‘í¬ë™1ê°€': 'ì¤‘êµ¬', 'ê´‘í¬ë™2ê°€': 'ì¤‘êµ¬',
    'ë©´ëª©ë™': 'ì¤‘ë‘êµ¬', 'ë¬µë™': 'ì¤‘ë‘êµ¬', 'ìƒë´‰ë™': 'ì¤‘ë‘êµ¬', 'ì¤‘í™”ë™': 'ì¤‘ë‘êµ¬', 'ë§ìš°ë™': 'ì¤‘ë‘êµ¬'
}
gdf_seoul["ìì¹˜êµ¬"] = gdf_seoul["LEGALDON_N"].map(dong_to_gu)
gdf_seoul = gdf_seoul.dropna(subset=["ìì¹˜êµ¬"])

# --- ìì¹˜êµ¬ë³„ ì§‘ê³„
streetlamp_count_by_gu = gdf_seoul["ìì¹˜êµ¬"].value_counts().reset_index()
streetlamp_count_by_gu.columns = ["ìì¹˜êµ¬", "ê°€ë¡œë“±ìˆ˜"]
cctv_count_by_gu = df_cctv["ìì¹˜êµ¬"].value_counts().reset_index()
cctv_count_by_gu.columns = ["ìì¹˜êµ¬", "CCTVìˆ˜"]

# --- ë²”ì£„ ë°ì´í„° ê°€ê³µ
df_crime_filtered = df_crime[["ìì¹˜êµ¬ë³„(2)", "2023", "2023.1", "2023.2", "2023.3", "2023.4", "2023.5"]].copy()
df_crime_filtered.columns = ["ìì¹˜êµ¬", "ì‚´ì¸", "ê°•ë„", "ì„±í­ë ¥", "ì ˆë„", "í­ë ¥", "ê¸°íƒ€"]

# --- ğŸ’¡ ì˜¤ë¥˜ ìˆ˜ì •: ìˆ«ìë¡œ ë³€í™˜ í›„ í•©ì‚°
for col in ["ì‚´ì¸", "ê°•ë„", "ì„±í­ë ¥", "ì ˆë„", "í­ë ¥"]:
    df_crime_filtered[col] = pd.to_numeric(df_crime_filtered[col], errors='coerce')

df_crime_filtered["ì´ë²”ì£„"] = df_crime_filtered[["ì‚´ì¸", "ê°•ë„", "ì„±í­ë ¥", "ì ˆë„", "í­ë ¥"]].sum(axis=1)

# --- ì¸êµ¬ ë°ì´í„° ì •ë¦¬
df_pop_filtered = df_population[["ë™ë³„(2)", "2024"]].copy()
df_pop_filtered.columns = ["ìì¹˜êµ¬", "ì¸êµ¬ìˆ˜"]
df_pop_grouped = df_pop_filtered.groupby("ìì¹˜êµ¬", as_index=False).sum()

# --- ë°ì´í„° ë³‘í•©
df_merge = streetlamp_count_by_gu.merge(cctv_count_by_gu, on="ìì¹˜êµ¬", how="outer")
df_merge = df_merge.merge(df_crime_filtered[["ìì¹˜êµ¬", "ì´ë²”ì£„"]], on="ìì¹˜êµ¬", how="outer")
df_merge = df_merge.merge(df_pop_grouped, on="ìì¹˜êµ¬", how="outer")
df_merge_clean = df_merge.dropna()

# --- í”¼ì–´ìŠ¨ ìƒê´€ê³„ìˆ˜ ë¶„ì„
correlation_matrix = df_merge_clean[["ê°€ë¡œë“±ìˆ˜", "CCTVìˆ˜", "ì´ë²”ì£„", "ì¸êµ¬ìˆ˜"]].corr(method="pearson")

# --- íˆíŠ¸ë§µ ì‹œê°í™”
plt.figure(figsize=(8, 6))
sns.heatmap(correlation_matrix, annot=True, cmap="coolwarm", fmt=".2f")
plt.title("ìì¹˜êµ¬ë³„ ìƒê´€ê´€ê³„ ë¶„ì„ (í”¼ì–´ìŠ¨ ìƒê´€ê³„ìˆ˜)")
plt.tight_layout()
plt.savefig("correlation_heatmap.png")
plt.show()